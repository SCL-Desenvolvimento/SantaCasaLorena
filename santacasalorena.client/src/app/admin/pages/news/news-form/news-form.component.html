<div class="news-form-container" *ngIf="!loading; else loadingTpl">
  <h2 class="mb-4">
    {{ isEditMode ? 'Editar Notícia' : 'Criar Nova Notícia' }}
  </h2>

  <form [formGroup]="newsForm" novalidate>
    <!-- Título -->
    <div class="mb-3">
      <label for="title" class="form-label">Título</label>
      <input
        type="text"
        id="title"
        class="form-control"
        formControlName="title"
        (blur)="generateSeoFromTitle()"
        [ngClass]="{ 'is-invalid': isFieldInvalid('title') }"
      />
      <div class="invalid-feedback">{{ getFieldError('title') }}</div>
    </div>

    <!-- Descrição -->
    <div class="mb-3">
      <label for="description" class="form-label">Resumo</label>
      <textarea
        id="description"
        class="form-control"
        rows="3"
        formControlName="description"
        (blur)="generateSeoFromDescription()"
        [ngClass]="{ 'is-invalid': isFieldInvalid('description') }"
      ></textarea>
      <div class="invalid-feedback">{{ getFieldError('description') }}</div>
    </div>

    <!-- Categoria -->
    <div class="mb-3">
      <label for="category" class="form-label">Categoria</label>
      <select
        id="category"
        class="form-select"
        formControlName="category"
        [ngClass]="{ 'is-invalid': isFieldInvalid('category') }"
      >
        <option value="">Selecione...</option>
        <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
      </select>
      <div class="invalid-feedback">{{ getFieldError('category') }}</div>
    </div>

    <!-- Tags -->
    <div class="mb-3">
      <label class="form-label">Tags</label>
      <div class="d-flex flex-wrap gap-2">
        <button
          *ngFor="let tag of availableTags"
          type="button"
          class="btn btn-sm"
          [class.btn-primary]="selectedTags.includes(tag)"
          [class.btn-outline-primary]="!selectedTags.includes(tag)"
          (click)="
            selectedTags.includes(tag) ? removeTag(tag) : addTag(tag)
          "
        >
          {{ tag }}
        </button>
      </div>
      <div class="mt-2">
        <input
          type="text"
          class="form-control"
          placeholder="Adicionar tag personalizada"
          (keyup.enter)="addCustomTag($event)"
        />
      </div>
      <div class="selected-tags mt-2">
        <span
          *ngFor="let tag of selectedTags"
          class="badge bg-secondary me-2"
        >
          {{ tag }}
          <button
            type="button"
            class="btn-close btn-close-white btn-sm ms-2"
            (click)="removeTag(tag)"
          ></button>
        </span>
      </div>
    </div>

    <!-- Imagem -->
    <div class="mb-3">
      <label class="form-label">Imagem da Notícia</label>
      <input
        type="file"
        id="imageInput"
        class="form-control"
        accept="image/*"
        (change)="onImageSelected($event)"
      />
      <div class="mt-2" *ngIf="imagePreview">
        <img
          [src]="imagePreview"
          alt="Prévia da imagem"
          class="img-thumbnail mb-2"
          style="max-height: 200px"
        />
        <button
          type="button"
          class="btn btn-outline-danger btn-sm"
          (click)="removeImage()"
        >
          Remover imagem
        </button>
      </div>
    </div>

    <!-- Conteúdo -->
    <div class="mb-3">
      <label class="form-label">Conteúdo</label>
      <quill-editor
        formControlName="content"
        [modules]="editorConfig"
        [ngClass]="{ 'is-invalid': isFieldInvalid('content') }"
      ></quill-editor>
      <div class="invalid-feedback d-block">{{ getFieldError('content') }}</div>
    </div>

    <!-- SEO -->
    <div class="seo-section mt-4 p-3 border rounded">
      <h5>Otimização para SEO</h5>

      <div class="mb-3">
        <label for="seoTitle" class="form-label">Título SEO</label>
        <input
          type="text"
          id="seoTitle"
          class="form-control"
          formControlName="seoTitle"
        />
      </div>

      <div class="mb-3">
        <label for="seoDescription" class="form-label">Descrição SEO</label>
        <textarea
          id="seoDescription"
          class="form-control"
          rows="2"
          formControlName="seoDescription"
        ></textarea>
      </div>

      <div class="mb-3">
        <label for="seoKeywords" class="form-label">Palavras-chave</label>
        <input
          type="text"
          id="seoKeywords"
          class="form-control"
          formControlName="seoKeywords"
        />
      </div>
    </div>

    <!-- Publicação -->
    <div class="form-check form-switch mt-4">
      <input
        class="form-check-input"
        type="checkbox"
        id="isPublished"
        formControlName="isPublished"
        (change)="onPublishToggle()"
      />
      <label class="form-check-label" for="isPublished">
        Publicar imediatamente
      </label>
    </div>

    <div *ngIf="newsForm.get('isPublished')?.value" class="mt-2">
      <label for="publishedAt" class="form-label">Data de publicação</label>
      <input
        type="datetime-local"
        id="publishedAt"
        class="form-control"
        formControlName="publishedAt"
      />
    </div>

    <!-- Botões -->
    <div class="mt-4 d-flex gap-2 flex-wrap">
      <button
        type="button"
        class="btn btn-outline-secondary"
        (click)="cancel()"
      >
        Cancelar
      </button>

      <button
        type="button"
        class="btn btn-warning"
        (click)="previewNews()"
      >
        Pré-visualizar
      </button>

      <button
        type="button"
        class="btn btn-info"
        (click)="saveDraft()"
        [disabled]="saving"
      >
        Salvar Rascunho
      </button>

      <button
        type="button"
        class="btn btn-success"
        (click)="publishNews()"
        [disabled]="saving"
      >
        {{ isEditMode ? 'Atualizar' : 'Publicar' }}
      </button>
    </div>
  </form>
</div>

<!-- Modal de preview -->
<div
  class="modal fade"
  id="previewModal"
  tabindex="-1"
  aria-labelledby="previewModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Pré-visualização da Notícia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h3>{{ newsForm.get('title')?.value }}</h3>
        <p class="text-muted">
          {{ newsForm.get('category')?.value }} •
          {{ newsForm.get('publishedAt')?.value | date: 'dd/MM/yyyy HH:mm' }}
        </p>

        <img
          *ngIf="imagePreview"
          [src]="imagePreview"
          alt="Imagem da notícia"
          class="img-fluid rounded mb-3"
        />

        <p class="lead">{{ newsForm.get('description')?.value }}</p>

        <div
          class="news-content"
          [innerHTML]="getSanitizedContent()"
        ></div>

        <div class="mt-3">
          <strong>Tags:</strong>
          <span *ngFor="let tag of selectedTags" class="badge bg-secondary me-1">
            {{ tag }}
          </span>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Fechar
        </button>
        <button
          type="button"
          class="btn btn-success"
          (click)="saveAndClosePreview()"
        >
          Publicar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<ng-template #loadingTpl>
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Carregando...</p>
  </div>
</ng-template>
